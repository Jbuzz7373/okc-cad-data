<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Oklahoma City CAD Calls</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    h2 {
      text-align: center;
      margin-top: 1rem;
    }
    #map {
      height: 500px;
      width: 100%;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }
    th {
      background-color: #f5f5f5;
    }
  </style>
</head>
<body>

<h2>Oklahoma City CAD Calls</h2>

<div id="map"></div>

<h3 style="margin-left: 10px;">Call Table</h3>
<table>
  <thead>
    <tr>
      <th>Incident #</th>
      <th>Response Date</th>
      <th>Problem</th>
      <th>Description</th>
      <th>Address</th>
      <th>Disposition</th>
      <th>Call Result</th>
    </tr>
  </thead>
  <tbody id="call-table-body">
    <!-- Table rows injected here -->
  </tbody>
</table>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([35.4676, -97.5164], 11); // Oklahoma City center
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let markersLayer = L.layerGroup().addTo(map);

  async function loadData() {
    try {
      const res = await fetch('CadCalls.json', { cache: 'no-cache' });
      const calls = await res.json();

      // Sort by ResponseDate descending
      calls.sort((a, b) => new Date(b.ResponseDate) - new Date(a.ResponseDate));

      const now = new Date();
      const twoHoursAgo = new Date(now.getTime() - 2 * 60 * 60 * 1000);

      // Clear old markers
      markersLayer.clearLayers();

      // Update map with last 2 hours
      calls.forEach(call => {
        const date = new Date(call.ResponseDate);
        if (date >= twoHoursAgo && call.Latitude && call.Longitude) {
          const marker = L.marker([call.Latitude, call.Longitude])
            .bindPopup(`<strong>${call.Problem}</strong><br>${call.Address}`);
          markersLayer.addLayer(marker);
        }
      });

      // Update table with all rows
      const tableBody = document.getElementById('call-table-body');
      tableBody.innerHTML = calls.map(call => `
        <tr>
          <td>${call.IncidentNumber || ''}</td>
          <td>${new Date(call.ResponseDate).toLocaleString()}</td>
          <td>${call.Problem || ''}</td>
          <td>${call.Description || ''}</td>
          <td>${call.Address || ''}</td>
          <td>${call.Disposition || ''}</td>
          <td>${call.CallCompleteInfo || ''}</td>
        </tr>
      `).join('');
    } catch (err) {
      console.error('Failed to load JSON:', err);
    }
  }

  loadData();
  setInterval(loadData, 5 * 60 * 1000); // Refresh every 5 minutes
</script>

</body>
</html>
