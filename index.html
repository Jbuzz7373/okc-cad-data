
<!DOCTYPE html>
<html>
<head>
  <title>Oklahoma City CAD Calls</title>
  <meta charset="utf-8" />
  <meta http-equiv="refresh" content="300">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    #map { height: 500px; }
    .popup-content { font-size: 16px; line-height: 1.5em; }
    .legend {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
    th { background-color: #f2f2f2; }
    tr:hover { background-color: #f1f1f1; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Oklahoma City CAD Calls</h2>
  <div id="map"></div>
  <div class="legend" id="legend"></div>
  <h3>Call Table</h3>
  <table id="callTable">
    <thead>
      <tr>
        <th>Incident #</th>
        <th>Response Date</th>
        <th>Problem</th>
        <th>Description</th>
        <th>Address</th>
        <th>Disposition</th>
        <th>Call Result</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    const iconMap = {
      "ASSAULT": "https://cdn-icons-png.flaticon.com/128/11575/11575191.png",
      "TRAFFIC": "https://cdn-icons-png.flaticon.com/128/1098/1098039.png",
      "911": "https://cdn-icons-png.flaticon.com/128/5973/5973800.png",
      "ACCIDENT": "https://cdn-icons-png.flaticon.com/128/865/865769.png",
      "ALARM": "https://cdn-icons-png.flaticon.com/128/159/159105.png",
      "BURGLARY": "https://cdn-icons-png.flaticon.com/128/789/789395.png",
      "WHITE COLLAR": "https://cdn-icons-png.flaticon.com/128/3799/3799939.png",
      "VANDALISM": "https://cdn-icons-png.flaticon.com/128/5549/5549611.png",
      "DOMESTIC": "https://cdn-icons-png.flaticon.com/128/889/889442.png",
      "DUI": "https://cdn-icons-png.flaticon.com/128/10870/10870331.png",
      "TRESPASS": "https://cdn-icons-png.flaticon.com/128/11668/11668983.png",
      "DISTURBANCE": "https://cdn-icons-png.flaticon.com/128/3596/3596061.png"
    };

    const map = L.map('map').setView([35.4676, -97.5164], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let markers = [];

    fetch('CadCalls.json')
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector("#callTable tbody");
        tbody.innerHTML = "";

        const now = new Date();
        const twoHoursAgo = new Date(now.getTime() - 2 * 60 * 60 * 1000);

        data.sort((a, b) => new Date(b.ResponseDate) - new Date(a.ResponseDate));

        data.forEach((call, index) => {
          const row = document.createElement("tr");
          ["IncidentNumber", "ResponseDate", "Problem", "Description", "Address", "Disposition", "CallCompleteInfo"].forEach(field => {
            const td = document.createElement("td");
            td.textContent = field === "ResponseDate" ? new Date(call[field]).toLocaleString() : call[field];
            row.appendChild(td);
          });
          tbody.appendChild(row);

          if (
            call.Latitude && call.Longitude &&
            new Date(call.ResponseDate) >= twoHoursAgo &&
            call.Disposition !== "z-CALL NOT ENTERED IN CAD"
          ) {
            let iconKey = Object.keys(iconMap).find(key => call.Problem.toUpperCase().includes(key)) || "TRAFFIC";
            const markerIcon = L.icon({
              iconUrl: iconMap[iconKey],
              iconSize: [28, 28],
              iconAnchor: [14, 28],
              popupAnchor: [0, -28]
            });

            const marker = L.marker([call.Latitude, call.Longitude], { icon: markerIcon }).addTo(map)
              .bindPopup(`<div class="popup-content"><b>${new Date(call.ResponseDate).toLocaleString()}</b><br>${call.Problem}<br>${call.Address}<br>${call.Disposition}</div>`);

            markers.push(marker);
            row.addEventListener('click', () => {
              map.setView([call.Latitude, call.Longitude], 15);
              marker.openPopup();
            });
          }
        });

        const legend = document.getElementById("legend");
        legend.innerHTML = "<b>Legend</b><br>";
        for (const [key, url] of Object.entries(iconMap)) {
          legend.innerHTML += `<img src="${url}" width="20" style="vertical-align:middle"> ${key}<br>`;
        }
      });
  </script>
</body>
</html>
