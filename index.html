<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="refresh" content="300" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Oklahoma City CAD Calls</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    #map { height: 500px; width: 100%; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
    th { background-color: #f2f2f2; text-align: left; }
    tr:hover { background-color: #f1f1f1; cursor: pointer; }
    .legend {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      line-height: 1.5em;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .legend img { vertical-align: middle; width: 20px; height: 20px; margin-right: 6px; }
  </style>
</head>
<body>
  <h2>Oklahoma City CAD Calls</h2>
  <div id="map"></div>
  <div class="legend" id="legend"></div>
  <h3>Call Table</h3>
  <table id="callTable">
    <thead>
      <tr>
        <th>Incident #</th>
        <th>Response Date</th>
        <th>Problem</th>
        <th>Description</th>
        <th>Address</th>
        <th>Disposition</th>
        <th>Call Result</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    const iconMap = {
      "911": "https://cdn-icons-png.flaticon.com/512/1034/1034131.png",
      "ASSAULT": "https://cdn-icons-png.flaticon.com/512/1809/1809383.png",
      "TRAFFIC": "https://cdn-icons-png.flaticon.com/512/743/743007.png",
      "ACCIDENT": "https://cdn-icons-png.flaticon.com/512/942/942748.png",
      "ALARM": "https://cdn-icons-png.flaticon.com/512/1046/1046776.png",
      "BURGLARY": "https://cdn-icons-png.flaticon.com/512/809/809957.png",
      "WHITE COLLAR": "https://cdn-icons-png.flaticon.com/512/1041/1041916.png",
      "VANDALISM": "https://cdn-icons-png.flaticon.com/512/1041/1041974.png",
      "DOMESTIC": "https://cdn-icons-png.flaticon.com/512/2857/2857380.png",
      "DUI": "https://cdn-icons-png.flaticon.com/512/1034/1034351.png",
      "TRESPASS": "https://cdn-icons-png.flaticon.com/512/2203/2203187.png",
      "DISTURBANCE": "https://cdn-icons-png.flaticon.com/512/1683/1683539.png"
    };

  const map = L.map('map', {
  minZoom: 10,
  maxZoom: 15
}).setView([35.4676, -97.5164], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    fetch('CadCalls.json')
      .then(response => response.json())
      .then(data => {
        const now = new Date();
        const markers = [];

        data.sort((a, b) => new Date(b.ResponseDate) - new Date(a.ResponseDate));

        const tbody = document.querySelector("#callTable tbody");
        data.forEach((call, i) => {
          const callDate = new Date(call.ResponseDate);
          const ageInMs = now - callDate;
          const ageInHours = ageInMs / 3600000;

          const exclude = call.Disposition && call.Disposition.includes("z-CALL NOT ENTERED IN CAD");
          if (!exclude && ageInHours <= 2) {
            const iconKey = Object.keys(iconMap).find(key => call.Problem?.toUpperCase().includes(key));
            const iconUrl = iconMap[iconKey] || "https://cdn-icons-png.flaticon.com/512/252/252025.png";

            const icon = L.icon({ iconUrl, iconSize: [25, 25] });
            const marker = L.marker([call.Latitude, call.Longitude], { icon }).addTo(map);
            marker.bindPopup(
              `<b>${new Date(call.ResponseDate).toLocaleString()}</b><br>${call.Problem}<br>${call.Address}<br>${call.Disposition}`
            );
            markers.push(marker);
            call._marker = marker;
          }

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${call.IncidentNumber}</td>
            <td>${new Date(call.ResponseDate).toLocaleString()}</td>
            <td>${call.Problem}</td>
            <td>${call.Description}</td>
            <td>${call.Address}</td>
            <td>${call.Disposition}</td>
            <td>${call.CallCompleteInfo}</td>
          `;
          row.addEventListener('click', () => {
            if (call._marker) {
              map.setView(call._marker.getLatLng(), 15);
              call._marker.openPopup();
            }
          });
          tbody.appendChild(row);
        });

        // Legend
        const legendDiv = document.getElementById("legend");
        legendDiv.innerHTML = "<b>Legend</b><br>";
        for (const [key, url] of Object.entries(iconMap)) {
          legendDiv.innerHTML += `<img src="${url}" alt="${key}"/> ${key}<br>`;
        }
      });
  </script>
</body>
</html>
